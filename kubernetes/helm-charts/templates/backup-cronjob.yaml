{{- if .Values.backup.enabled }}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "detection-api.fullname" . }}-backup
  labels:
    {{- include "detection-api.labels" . | nindent 4 }}
    component: backup
spec:
  schedule: {{ .Values.backup.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 1800  # 30 minutes max
      template:
        metadata:
          labels:
            {{- include "detection-api.selectorLabels" . | nindent 12 }}
            component: backup
        spec:
          serviceAccountName: {{ include "detection-api.serviceAccountName" . }}
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
          containers:
            - name: backup
              image: "{{ .Values.image.registry }}/{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
                  echo "[INFO] Starting backup at ${TIMESTAMP}"

                  # Backup SQLite queue
                  if [ -f /app/data/queue.db ]; then
                    cp /app/data/queue.db /tmp/queue-${TIMESTAMP}.db
                    echo "[INFO] Queue backup created: queue-${TIMESTAMP}.db"
                  fi

                  # Upload to S3 if AWS CLI available
                  if command -v aws &>/dev/null; then
                    aws s3 cp /tmp/queue-${TIMESTAMP}.db \
                      s3://{{ include "detection-api.fullname" . }}-backups/queue/${TIMESTAMP}/ \
                      --sse aws:kms
                    echo "[INFO] Backup uploaded to S3"
                  fi

                  echo "[INFO] Backup completed successfully"
              volumeMounts:
                - name: persistent-storage
                  mountPath: /app/data
                  readOnly: true
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
          volumes:
            - name: persistent-storage
              persistentVolumeClaim:
                claimName: {{ include "detection-api.fullname" . }}-queue-pvc
{{- end }}
