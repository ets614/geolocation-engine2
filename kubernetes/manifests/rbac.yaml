# Kubernetes RBAC Configuration for Detection API
# File: kubernetes/manifests/rbac.yaml

---
# ServiceAccount for Detection API
apiVersion: v1
kind: ServiceAccount
metadata:
  name: detection-api-sa
  namespace: default
  labels:
    app: detection-api

---
# Role for Detection API (namespace-scoped)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: detection-api-role
  namespace: default
  labels:
    app: detection-api
rules:
  # Read ConfigMaps (geolocation thresholds)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch"]

  # Read Secrets (TAK server credentials)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]

  # Read PersistentVolumes and Claims
  - apiGroups: [""]
    resources: ["persistentvolumes", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch"]

  # Read Pods (for debugging)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

  # Read Pod logs (for troubleshooting)
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get"]

---
# RoleBinding for Detection API
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: detection-api-rolebinding
  namespace: default
  labels:
    app: detection-api
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: detection-api-role
subjects:
  - kind: ServiceAccount
    name: detection-api-sa
    namespace: default

---
# ServiceAccount for Prometheus (monitoring)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-sa
  namespace: monitoring
  labels:
    app: prometheus

---
# ClusterRole for Prometheus (cluster-wide metrics)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-role
  labels:
    app: prometheus
rules:
  # Access nodes for metrics
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/metrics
      - nodes/proxy
    verbs: ["get", "list", "watch"]

  # Access services and endpoints
  - apiGroups: [""]
    resources:
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]

  # Access ingresses
  - apiGroups: ["extensions", "networking.k8s.io"]
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]

  # Access deployments and replicas
  - apiGroups: ["apps"]
    resources:
      - deployments
      - daemonsets
      - replicasets
      - statefulsets
    verbs: ["get", "list", "watch"]

  # Access jobs
  - apiGroups: ["batch"]
    resources:
      - jobs
      - cronjobs
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding for Prometheus
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-rolebinding
  labels:
    app: prometheus
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-role
subjects:
  - kind: ServiceAccount
    name: prometheus-sa
    namespace: monitoring

---
# Role for Detection API Operations (manual troubleshooting)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: detection-api-operations
  namespace: default
  labels:
    app: detection-api
rules:
  # Restart deployments
  - apiGroups: ["apps"]
    resources: ["deployments", "deployments/scale"]
    verbs: ["get", "list", "patch", "update"]

  # Port forward for debugging
  - apiGroups: [""]
    resources: ["pods/portforward"]
    verbs: ["get", "create"]

  # Execute commands in pods
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]

---
# RoleBinding for Detection API Operations (DevOps team)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: detection-api-operations-binding
  namespace: default
  labels:
    app: detection-api
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: detection-api-operations
subjects:
  - kind: Group
    name: "devops-team"
    apiGroup: rbac.authorization.k8s.io
  - kind: Group
    name: "sre-team"
    apiGroup: rbac.authorization.k8s.io

---
# Role for Detection API Read-Only Access (support/engineering)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: detection-api-readonly
  namespace: default
  labels:
    app: detection-api
rules:
  # Read deployments and pods
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets", "statefulsets"]
    verbs: ["get", "list", "watch"]

  - apiGroups: [""]
    resources: ["pods", "pods/log", "events"]
    verbs: ["get", "list", "watch"]

  # Read configuration
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]

---
# RoleBinding for Detection API Read-Only
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: detection-api-readonly-binding
  namespace: default
  labels:
    app: detection-api
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: detection-api-readonly
subjects:
  - kind: Group
    name: "engineering"
    apiGroup: rbac.authorization.k8s.io
  - kind: Group
    name: "support"
    apiGroup: rbac.authorization.k8s.io

---
# ServiceAccount for Detection API CI/CD Deployments
apiVersion: v1
kind: ServiceAccount
metadata:
  name: detection-api-deployer-sa
  namespace: default
  labels:
    app: detection-api

---
# Role for Detection API Deployments (CI/CD)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: detection-api-deployer-role
  namespace: default
  labels:
    app: detection-api
rules:
  # Update image
  - apiGroups: ["apps"]
    resources: ["deployments", "deployments/scale"]
    verbs: ["get", "list", "patch", "update"]

  # Rollout status
  - apiGroups: ["apps"]
    resources: ["deployments/rollback"]
    verbs: ["create"]

  # Manage pods
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "delete", "watch"]

  # Service patch (for blue-green traffic switch)
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "patch", "update"]

  # Read secrets for configuration
  - apiGroups: [""]
    resources: ["secrets", "configmaps"]
    verbs: ["get", "list"]

---
# RoleBinding for Detection API Deployer (GitHub Actions)
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: detection-api-deployer-binding
  namespace: default
  labels:
    app: detection-api
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: detection-api-deployer-role
subjects:
  - kind: ServiceAccount
    name: detection-api-deployer-sa
    namespace: default

---
# ClusterRole for Operators (audit & monitoring)
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: operator-audit-viewer
  labels:
    app: detection-api
rules:
  # View audit logs
  - apiGroups: ["audit.k8s.io"]
    resources: ["events"]
    verbs: ["get", "list", "watch"]

  # View events
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]

---
# ClusterRoleBinding for Operators
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: operator-audit-viewer-binding
  labels:
    app: detection-api
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: operator-audit-viewer
subjects:
  - kind: Group
    name: "operators"
    apiGroup: rbac.authorization.k8s.io

---
# Network Policy Namespace (restrict to default namespace)
apiVersion: v1
kind: Namespace
metadata:
  name: default
  labels:
    name: default
