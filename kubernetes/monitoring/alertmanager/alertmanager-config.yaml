# Alertmanager Configuration for Detection API
# Routes alerts to appropriate channels based on severity

apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-detection-api
  namespace: monitoring
  labels:
    app: alertmanager
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
      slack_api_url: 'https://hooks.slack.com/services/PLACEHOLDER'

    route:
      group_by: ['alertname', 'severity', 'team']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default'
      routes:
        # Critical alerts: immediate notification
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 10s
          repeat_interval: 1h
          continue: true

        # SLO alerts: dedicated channel
        - match_re:
            slo: '.+'
          receiver: 'slo-alerts'
          group_wait: 30s
          repeat_interval: 2h

        # Warning alerts: standard notification
        - match:
            severity: warning
          receiver: 'warning-alerts'
          group_wait: 1m
          repeat_interval: 4h

    receivers:
      - name: 'default'
        slack_configs:
          - channel: '#detection-api-alerts'
            send_resolved: true
            title: '{{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Severity:* {{ .Labels.severity }}
              {{ end }}

      - name: 'critical-alerts'
        slack_configs:
          - channel: '#detection-api-critical'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
            title: 'CRITICAL: {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              *Runbook:* {{ .Annotations.runbook_url }}
              {{ end }}
        # PagerDuty for critical production incidents
        # pagerduty_configs:
        #   - service_key: 'PLACEHOLDER'
        #     severity: 'critical'

      - name: 'slo-alerts'
        slack_configs:
          - channel: '#detection-api-slo'
            send_resolved: true
            title: 'SLO Alert: {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *SLO:* {{ .Labels.slo }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              {{ end }}

      - name: 'warning-alerts'
        slack_configs:
          - channel: '#detection-api-alerts'
            send_resolved: true
            title: 'Warning: {{ .GroupLabels.alertname }}'
            text: >-
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              {{ end }}

    inhibit_rules:
      # If a critical alert is firing, suppress related warnings
      - source_match:
          severity: critical
        target_match:
          severity: warning
        equal: ['alertname']
