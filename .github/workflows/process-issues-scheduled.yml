name: Process Issues Scheduled

# Run every 5 minutes to check for pending issues (GitHub Actions minimum)
on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes (fastest possible)
  workflow_dispatch:  # Manual trigger

jobs:
  process-pending:
    name: Process Pending Issue Jobs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml

      - name: Find pending jobs
        id: pending
        run: |
          import json
          import os
          from pathlib import Path

          job_files = list(Path('.nwave/jobs').glob('issue-*.json'))
          pending_jobs = []

          for job_file in job_files:
            with open(job_file) as f:
              job = json.load(f)
              if job.get('status') == 'pending':
                pending_jobs.append(job)

          if pending_jobs:
            print(f"Found {len(pending_jobs)} pending jobs")
            for job in pending_jobs:
              agent_name = job.get('agent_name', job.get('agent', 'unknown'))
              skill = job.get('skill', 'unknown')
              print(f"  - Issue #{job['issue_number']}: {agent_name} ({skill})")

            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"count={len(pending_jobs)}\n")
              f.write(f"jobs={json.dumps(pending_jobs)}\n")
          else:
            print("No pending jobs found")
        shell: python3 {0}

      - name: Update job status - processing
        if: steps.pending.outputs.count > 0
        run: |
          import json
          import os
          from datetime import datetime
          from pathlib import Path

          jobs = json.loads('${{ steps.pending.outputs.jobs }}'.replace("'", '"'))

          for job in jobs:
            job_file = Path(f".nwave/jobs/issue-{job['issue_number']}.json")
            job['status'] = 'processing'
            job['started_at'] = datetime.utcnow().isoformat() + 'Z'
            with open(job_file, 'w') as f:
              json.dump(job, f, indent=2)

          # Commit status update
          os.system('git config user.name "Claude Code Agent"')
          os.system('git config user.email "claude@anthropic.com"')
          os.system('git add .nwave/jobs/*.json')
          os.system('git commit -m "chore: Update job status to processing" || true')
          os.system('git push || true')
        shell: python3 {0}

      - name: Process agent tasks
        if: steps.pending.outputs.count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = JSON.parse('${{ steps.pending.outputs.jobs }}'.replace(/'/g, '"'));

            console.log(`Processing ${jobs.length} total agent tasks...`);

            for (const job of jobs) {
              const agentName = job.agent_name || job.agent || 'unknown';
              const skill = job.skill || 'unknown';

              console.log(`Executing ${skill} for issue #${job.issue_number} (Agent: ${agentName})`);

              // Generate skill-specific message
              let skillMessage = '';
              if (skill === 'nw:design') {
                skillMessage = `ğŸ‘¤ **${agentName}** is designing the architecture...`;
              } else if (skill === 'nw:distill') {
                skillMessage = `âœ… **${agentName}** is creating acceptance tests...`;
              } else if (skill === 'nw:deliver') {
                skillMessage = `ğŸ’» **${agentName}** is implementing the feature...`;
              } else if (skill === 'nw:devops') {
                skillMessage = `ğŸš€ **${agentName}** is setting up infrastructure...`;
              } else if (skill === 'nw:root-why') {
                skillMessage = `ğŸ” **${agentName}** is analyzing the issue...`;
              } else if (skill === 'nw:finalize') {
                skillMessage = `ğŸ“š **${agentName}** is documenting the work...`;
              } else if (skill === 'nw:research') {
                skillMessage = `ğŸ”¬ **${agentName}** is researching the topic...`;
              } else {
                skillMessage = `ğŸ¤– **${agentName}** is processing...`;
              }

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: job.issue_number,
                body: `ğŸ¤– **Agent Processing Started**\n\n${skillMessage}\n\nSkill: \`${skill}\`\n\nâ³ Expected PR creation in ~2-5 minutes\n\nğŸ”— [View Workflow Runs](${context.server_url}/${context.repo.owner}/${context.repo.repo}/actions)`
              });
            }

      - name: Update job status - completed
        if: success()
        run: |
          import json
          import os
          from pathlib import Path

          job_files = list(Path('.nwave/jobs').glob('issue-*.json'))

          for job_file in job_files:
            with open(job_file) as f:
              job = json.load(f)

            if job.get('status') == 'processing':
              # Note: In real implementation, check if PR was created before marking complete
              # For now, we just log
              print(f"Issue #{job['issue_number']} job would be marked complete after PR creation")
        shell: python3 {0}
