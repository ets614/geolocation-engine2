name: Issue to PR Workflow

on:
  issues:
    types: [opened, labeled, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

jobs:
  route-issue:
    name: Route Issue to Agent
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: write
    outputs:
      agent-type: ${{ steps.determine.outputs.agent }}
      issue-title: ${{ steps.determine.outputs.title }}
      issue-body: ${{ steps.determine.outputs.body }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || context.inputs.issue_number;
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body);
            core.setOutput('labels', JSON.stringify(issue.data.labels.map(l => l.name)));
            core.setOutput('number', issueNumber);

      - name: Determine agent type
        id: determine
        env:
          LABELS: ${{ steps.issue.outputs.labels }}
          TITLE: ${{ steps.issue.outputs.title }}
        run: |
          AGENT="nw:deliver"

          if echo "$LABELS" | grep -q '"phase-04"'; then
            AGENT="nw:deliver"
          elif echo "$LABELS" | grep -q '"phase-05"'; then
            AGENT="nw:devops"
          elif echo "$LABELS" | grep -q '"research"'; then
            AGENT="nw:research"
          elif echo "$LABELS" | grep -q '"design"'; then
            AGENT="nw:design"
          elif echo "$LABELS" | grep -q '"bug"'; then
            AGENT="nw:troubleshooter"
          fi

          echo "agent=$AGENT" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create job marker file
        run: |
          mkdir -p .nwave/jobs
          CREATED_AT=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          cat > ".nwave/jobs/issue-${{ steps.issue.outputs.number }}.json" << EOF
          {
            "issue_number": ${{ steps.issue.outputs.number }},
            "agent": "${{ steps.determine.outputs.agent }}",
            "status": "pending",
            "created_at": "$CREATED_AT"
          }
          EOF

      - name: Commit job marker
        if: always()
        run: |
          git config user.name "Claude Code Agent"
          git config user.email "claude@anthropic.com"
          git add .nwave/jobs/issue-*.json
          git commit -m "chore: Create job marker for issue #${{ steps.issue.outputs.number }}" || echo "No changes to commit"
          git push

  notify:
    name: Notify Issue Routed
    runs-on: ubuntu-latest
    needs: route-issue
    if: success()
    permissions:
      issues: write
    steps:
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || context.inputs.issue_number;
            const agent = "${{ needs.route-issue.outputs.agent-type }}";
            const body = `ðŸ¤– **Agent Routing**: \`${agent}\`\n\nThis issue has been routed to **${agent}** for execution.\n\nðŸ“ **Next Steps:**\nThe agent will process this issue and create a PR with the implementation.\n\nðŸ‘€ Watch for the PR creation notification.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: body
            });
