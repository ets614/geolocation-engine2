name: Issue to PR Workflow

on:
  issues:
    types: [opened, labeled, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

jobs:
  route-issue:
    name: Route Issue to Agent
    runs-on: ubuntu-latest
    permissions:
      issues: read
      contents: read
    outputs:
      agent-type: ${{ steps.determine.outputs.agent }}
      issue-title: ${{ steps.determine.outputs.title }}
      issue-body: ${{ steps.determine.outputs.body }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || context.inputs.issue_number;
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body);
            core.setOutput('labels', JSON.stringify(issue.data.labels.map(l => l.name)));
            core.setOutput('number', issueNumber);

      - name: Determine agent type
        id: determine
        run: |
          labels="${{ steps.issue.outputs.labels }}"
          title="${{ steps.issue.outputs.title }}"

          if [[ "$labels" == *"phase-04"* ]]; then
            echo "agent=nw:deliver" >> $GITHUB_OUTPUT
          elif [[ "$labels" == *"phase-05"* ]]; then
            echo "agent=nw:devops" >> $GITHUB_OUTPUT
          elif [[ "$labels" == *"research"* ]]; then
            echo "agent=nw:research" >> $GITHUB_OUTPUT
          elif [[ "$labels" == *"design"* ]]; then
            echo "agent=nw:design" >> $GITHUB_OUTPUT
          elif [[ "$labels" == *"bug"* ]]; then
            echo "agent=nw:troubleshooter" >> $GITHUB_OUTPUT
          else
            echo "agent=nw:deliver" >> $GITHUB_OUTPUT
          fi

          echo "title=${{ steps.issue.outputs.title }}" >> $GITHUB_OUTPUT
          echo "body=${{ steps.issue.outputs.body }}" >> $GITHUB_OUTPUT

      - name: Create job marker file
        run: |
          mkdir -p .nwave/jobs
          cat > ".nwave/jobs/issue-${{ steps.issue.outputs.number }}.json" << 'EOF'
          {
            "issue_number": ${{ steps.issue.outputs.number }},
            "title": "${{ steps.determine.outputs.title }}",
            "agent": "${{ steps.determine.outputs.agent }}",
            "status": "pending",
            "created_at": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF

      - name: Commit job marker
        if: always()
        run: |
          git config user.name "Claude Code Agent"
          git config user.email "claude@anthropic.com"
          git add .nwave/jobs/issue-*.json || true
          git commit -m "chore: Create job marker for issue #${{ steps.issue.outputs.number }}" || true
          git push || true

  notify:
    name: Notify Issue Routed
    runs-on: ubuntu-latest
    needs: route-issue
    steps:
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || context.inputs.issue_number;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ¤– **Agent Routing**: \`${{ needs.route-issue.outputs.agent-type }}\`\n\nThis issue has been routed to **${{ needs.route-issue.outputs.agent-type }}** for execution.\n\nðŸ“ **Next Steps:**\nThe agent will process this issue and create a PR with the implementation.\n\nðŸ‘€ Watch for the PR creation notification.`
            });
