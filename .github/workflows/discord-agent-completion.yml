name: Discord Agent Completion Notification

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  notify-completion:
    name: Notify Agent Completion
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Detect agent completion
        id: detect
        run: |
          import json
          import os
          import re
          from pathlib import Path

          # Check if PR closes an issue with a job marker
          pr_body = """${{ github.event.pull_request.body }}"""

          # Look for "Resolves #N" or "Closes #N"
          matches = re.findall(r'(?:Resolves|Closes)\s+#(\d+)', pr_body)

          if matches:
            issue_num = matches[0]
            job_file = Path(f'.nwave/jobs/issue-{issue_num}.json')

            if job_file.exists():
              print(f"Found issue #{issue_num} with job marker")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"issue_number={issue_num}\n")
                f.write(f"has_job_marker=true\n")
              exit(0)

          print("No agent job marker found")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"has_job_marker=false\n")
        shell: python3 {0}

      - name: Send Discord notification
        if: steps.detect.outputs.has_job_marker == 'true'
        run: |
          python3 scripts/discord-notify-agent-completion.py \
            --issue ${{ steps.detect.outputs.issue_number }}
